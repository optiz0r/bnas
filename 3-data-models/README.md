# Building Network Automation Systems - Data Models

## Problem

Templating the definition of a resilient BGP peering with a third party
and and presenting connectivity to internal client machines.

The standard network pattern will involve:

- Two switches at each location with a layer 3 point-to-point link between them
- A layer-3 hand off to the third party from each switch
- An eBGP peering on each switch to the third party
- An iBGP peering between the switch pair (not implemented yet)
- A VLAN presented to the client machines on trunk ports from each switch
- VRRP running on the client VLAN between the two switches
- An access-list permitting outbound connectivity to all targets, and select
  inbound multicast traffic

## Models

### Infrastructure

For each location, defines:

- BGP ASN
- Address space for point-to-point links
- Address space for client networks
- VLAN range

Example:

```yaml
---
infra:
  s01: # Site code
    asn: 64001 # Local AS number
    vlan_start: 100 # Client VLANs start from 100
    # Subnet allocations
    summary_network:  192.168.32.0/20
    routerid_network: 192.168.47.128/25 # 192.168.47.129/32 - 192.168.47.255/32
    ptp_networks:     192.168.47.0/25   # 192.168.47.0/30   - 192.168.47.124/30
    service_networks: 192.168.46.0/24   # 192.168.46.0/30   - 192.168.46.252.0/30
    client_networks:  192.168.36.0/22   # 192.168.32.0/27   - 192.168.39.224/27
    clients: 3  # There are three client machines in site 1
```

### Service

For each third party peering

- Index of the service
- Service name/description
- BGP peer details (remote AS, peering network, address assignment, timers)
- List of prefixes to accept
- List of permitted multicast destinations

Example:

```yaml
service_defaults:
  bgp:
    timers: "5 15" # Default BGP timers

services:
  - index: 0 # All services must have a unique index, starting from 0
    location: "s01" # Site Code for this location (must match infra model)
    name: initech # Name of this service (third party), lowercase alphanumeric only
    neighbours:
      left:
        asn: 65001 # Left AS number
        # Peer IP details
        network: 172.16.0.0/30
        local_address: 172.16.0.2/30
        peer_address: 172.16.0.1/30
      right:
        asn: 65001
        network: 172.16.0.4/30
        local_address: 172.16.0.6/30
        peer_address: 172.16.0.5/30
    prefixes: # List of prefixes that will be advertised to us and must be accepted
      - 172.16.1.0/24
      - 172.16.2.0/24
    multicast_ranges: # List of multicast ranges published by service
      - 227.16.1.0/24
      - 227.16.2.0/24
```

### Device

Auto-generated model per device, using information derived from the
Infrastructure and Service data models.

The location and whether the device is on the left or right hand side of the
switch pair will be inferred from the device hostname, for example, a switch
named `s01ncore1` will be treated as the left hand side of the pair, and inherit
config from the s01 location. These can both be overridden using `host_vars`

- `location`: name of a location from the infra model this device is at
- `side`: left or right

Example:

```yaml
# host_vars/s05ncore6.yml
# This host has a non-standard name, so re-map it to the left switch in site 1
---
location: s01
side: "left"
```

## Templates

For each device, a partial configuration will be generated

## Playbook

### fabric.yml

Runs the following tasks

- Converts the network-level data model into the device-level data models
- Generates the configuration for each device

Device models are written to `outputs/{{ inventory_hostname }}/device.yml`
Final config files are written to `outputs/{{ inventory_hostname }}/device.config`

## Usage

For the lab environment:

```
ansible-playbook ./fabric.yml
```

For a production environment:

```
ansible-playbook -i ~/ansible/production/inventory ./fabric.yml
```

## Examples

Example configs generated by the models can be found in the `exmaples` directory.
These configs and device model files are exactly what would be generated if running
this code locally without modifications.
